<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MTG - Results</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link rel="stylesheet" href="/static/mtg/styles.css">
</head>
<body class="index-page">
    <div id="App"></div>
    <script type="text/babel">

        const RenderNavbar = ({handleView}) => {
            return (
                <div className="navbar">
                        <button className="btn btn-sm btn-outline-primary" onClick={() => handleView("home")}>Home</button>
                        <button className="btn btn-sm btn-outline-primary" onClick={() => handleView("stats")}>My Stats</button>
                        <button className="btn btn-sm btn-outline-primary" onClick={() => handleView("decks")}>Best Decks</button>
                        <button className="btn btn-sm btn-outline-primary" onClick={() => handleView("chart")}>Chart</button>
                        <button className="btn btn-sm btn-outline-primary" onClick={() => handleView("tournament")}>Tournament</button>
                        <a className="btn btn-danger out" href="/logout">Log Out</a>
                    <hr/>
                </div>
            );
        };

        function App() {
            const [currentView, setCurrentView] = React.useState("home");
            const [category, setCategory] = React.useState("all");
            const [selectedDeck, setSelectedDeck] = React.useState(null);
            const [selectedPlayer, setSelectedPlayer] = React.useState(null);
            const [loggedInUserId, setLoggedInUserId] = React.useState(null);

            // Fetch logged-in user ID on load
            React.useEffect(() => {
                fetch(`/get_user/${parseInt({{ user.id }})}`)
                    .then(response => response.json())
                    .then(data => setLoggedInUserId(data.id))
                    .catch(error => console.error("Error fetching logged-in user ID:", error));
            }, []);

            const handleView = (view) => {
                setCurrentView(view)
                setSelectedDeck(null)

                // If "My Stats" is clicked, use logged-in user ID
                setSelectedPlayer(view === "stats" ? { id: loggedInUserId } : null);
            }
            return (
                <div>
                    {/* NavBar */}
                    <RenderNavbar
                        handleView={handleView}
                    />
                    <hr />

                    {/* View */}
                    {selectedDeck ? (
                        <RenderDeck
                            selectedDeck={selectedDeck}
                            setSelectedDeck={setSelectedDeck}
                            setSelectedPlayer={setSelectedPlayer}
                        />
                    ) : selectedPlayer ?  (
                        <RenderPlayer
                            selectedPlayer={selectedPlayer}
                            setSelectedDeck={setSelectedDeck}
                            loggedInUserId={loggedInUserId}
                        />
                    ) : currentView === "decks" ? (
                        <RenderBestDecks
                            setSelectedPlayer={setSelectedPlayer}
                            setSelectedDeck={setSelectedDeck}
                        />
                    ) : (
                        <RenderResults
                            setSelectedDeck={setSelectedDeck}
                            setSelectedPlayer={setSelectedPlayer}
                        />
                    )}
                </div>
            );
        };

        const RenderResults = ({ setSelectedDeck, setSelectedPlayer }) => {
            const [results, setResults] = React.useState([]);
            const [bestDeck, setBestDeck] = React.useState([]);
            const [bestPlayer, setBestPlayer] = React.useState([]);
            const [showForm, setShowForm] = React.useState(false);
            const [userDecks, setUserDecks] = React.useState([]); // Options for user's decks (deck1)
            const [rivalDecks, setRivalDecks] = React.useState([]); // Options for all other decks (deck2)
            const [resultOptions, setResultOptions] = React.useState([]); // Options for match results

            React.useEffect(() => {
                const url = `/get_results`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then(data => {
                        setResults(data["matches"]);
                        setBestDeck(data["best_deck"]);
                        setBestPlayer(data["best_player"]);
                    })
                    .catch(error => console.error("There was a problem while fetching results", error))
            }, []); // Empty array means this effect runs only once after the initial render

            const handleDeckClick = (deckId) => {
                setSelectedPlayer(null)
                setSelectedDeck({ id: deckId });
            };

            const handlePlayerClick = (playerId) => {
                setSelectedDeck(null)
                setSelectedPlayer({ id: playerId });
            };

            // Fetch deck options and match results on form open
            const fetchOptions = async () => {
                try {
                    const response = await fetch("/get_options/result");
                    const data = await response.json();
                    setUserDecks(data["decks"]);
                    setRivalDecks(data["rival_decks"]);
                    setResultOptions(data["results_match"]);
                } catch (error) {
                    console.error("Error fetching options:", error);
                }
            };

            // Function to get CSRF token from cookies
            function getCSRFToken() {
                const cookies = document.cookie.split("; ");
                for (let cookie of cookies) {
                    if (cookie.startsWith("csrftoken=")) {
                        return cookie.split("=")[1];
                    }
                }
                return "";
            }

            const handleSubmitForm = (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);

                fetch('/add_match', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    }
                }).then(response => {
                    if (response.ok) {
                        setShowForm(false);
                        window.location.reload();
                    } else {
                        console.error("Failed to add match");
                    }
                });
            };

            const handleAddClick = () => {
                setShowForm(true);
                fetchOptions();
            }

            React.useEffect(() => {
            }, [userDecks, rivalDecks, resultOptions]);

            return (
                <div className="results-page-container">
                    {/* Top tables: Best Player and Best Deck */}
                    <div className="top-tables-container">
                        <div className="best-player-table">
                            <table className="table">
                                <thead className="best-player-header">
                                <tr>
                                    <th scope="col">Best Player</th>
                                    <th scope="col">Victories</th>
                                    <th scope="col">Matches Played</th>
                                    <th scope="col">Win Ratio</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td className="clickable"
                                        onClick={() => handlePlayerClick(bestPlayer.id)}>{bestPlayer.username}</td>
                                    <td>{bestPlayer.wins}</td>
                                    <td>{bestPlayer.total_matches}</td>
                                    <td>{bestPlayer.win_ratio}%</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="best-deck-table">
                            <table className="table">
                                <thead className="best-deck-header">
                                <tr>
                                    <th scope="col">Best Deck</th>
                                    <th scope="col">Owner</th>
                                    <th scope="col">Victories</th>
                                    <th scope="col">Matches Played</th>
                                    <th scope="col">Win Ratio</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td className="clickable"
                                        onClick={() => handleDeckClick(bestDeck.id)}>{bestDeck.name}</td>
                                    <td className="clickable"
                                        onClick={() => handlePlayerClick(bestDeck.ownerId)}>{bestDeck.owner}</td>
                                    <td>{bestDeck.wins}</td>
                                    <td>{bestDeck.total_matches}</td>
                                    <td>{bestDeck.win_ratio}%</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Results table */}
                    <div className="results-table">
                        <table className="table">
                            <thead className="table-light, table-results">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Deck1</th>
                                <th scope="col">Result</th>
                                <th scope="col">Deck2</th>
                                <th scope="col">Datetime</th>
                            </tr>
                            </thead>
                            <tbody className="table-group-divider">
                            {results.length > 0 && results.map((match, index) => (
                                <tr key={index}>
                                    <th scope="row">{index + 1}</th>
                                    <td className="clickable"
                                        onClick={() => handleDeckClick(match.deck1.id)}>{match.deck1.name}</td>
                                    <td>{match.result}</td>
                                    <td className="clickable"
                                        onClick={() => handleDeckClick(match.deck2.id)}>{match.deck2.name}</td>
                                    <td>{match.date_played}</td>
                                </tr>
                            ))}
                            <tr>
                                <td>
                                    <button className="button-add" onClick={handleAddClick}>
                                        <img src="/static/mtg/img/add-button.png" alt="Add Result"/>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    {/* Form to add new match */}
                    {showForm && (
                        <form onSubmit={handleSubmitForm} className="add-match-form">
                            <h3>Add New Match</h3>
                            <div>
                                <label>Deck 1: </label>
                                <select name="deck1">
                                    {userDecks.map(deck => (
                                        <option key={deck.id} value={deck.id}>{deck.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label>Result: </label>
                                <select name="result">
                                    {resultOptions.map(result => (
                                        <option key={result.id} value={result.id}>{result.label}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label>Deck 2: </label>
                                <select name="deck2">
                                    {rivalDecks.map(rivalDeck => (
                                        <option key={rivalDeck.id} value={rivalDeck.id}>{rivalDeck.name}</option>
                                    ))}
                                </select>
                            </div>
                            <button type="submit">Submit</button>
                            <button type="button" onClick={() => setShowForm(false)}>Cancel</button>

                        </form>
                    )}
                </div>
            );
        };

        const RenderDeck = ({ selectedDeck, setSelectedDeck, setSelectedPlayer }) => {
            const [deck, setDeck] = React.useState(null);  // Move useState here
            const deckId = selectedDeck && selectedDeck.id;

            React.useEffect(() => {
                if (deckId) {
                    const url = `/get_deck/${deckId}`;

                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data);
                            setDeck(data);
                        })
                        .catch(error => console.error(`There was a problem while fetching deck with ID: ${deckId}`, error));
                }
            }, [deckId]); // Only re-run the effect if deckId changes

            if (!deck || !deck.rivals) {
                return <div>No data available for this deck.</div>;
            }

            const rivals = deck.rivals;

            const handleRivalDeckClick = (rivalId) => {
                console.log(rivalId);
                setSelectedPlayer(null)
                setSelectedDeck({ id: rivalId });
            };

            const handleRivalOwnerClick = (rivalOwnerId) => {
                console.log(rivalOwnerId);
                setSelectedDeck(null)
                setSelectedPlayer({ id: rivalOwnerId })
            };

            return (
                <div>
                    <h1>{deck.category} - {deck.name}. Win Ratio: {deck.win_ratio}%</h1>
                    <div className="results-page-container">
                        <div className="results-table">
                            <table className="table">
                                <thead className="table-light, table-results">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Rival</th>
                                        <th scope="col">Owner</th>
                                        <th scope="col">Total Matches</th>
                                        <th scope="col">Victories</th>
                                        <th scope="col">Defeats</th>
                                        <th scope="col">Draws</th>
                                        <th scope="col">Win Ratio</th>
                                    </tr>
                                </thead>
                                <tbody className="table-group-divider">
                                    {rivals.map((rival, index) => (
                                        <tr key={rival.id}>
                                            <th scope="row">{index + 1}</th>
                                            <td className="clickable" onClick={() => handleRivalDeckClick(rival.id)}>{rival.name}</td>
                                            <td className="clickable" onClick={() => handleRivalOwnerClick(rival.owner.id)}>{rival.owner.username}</td>
                                            <td>{rival.stats.total}</td>
                                            <td>{rival.stats.wins}</td>
                                            <td>{rival.stats.losses}</td>
                                            <td>{rival.stats.draws}</td>
                                            <td>{rival.stats.win_ratio}%</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const RenderPlayer = ({ selectedPlayer, setSelectedDeck, loggedInUserId }) => {
            const [player, setPlayer] = React.useState(null);
            const [decksPlayer, setDecksPlayer] = React.useState([]);
            const [showForm, setShowForm] = React.useState(false);
            const [category, setCategory] = React.useState([]);

            const playerId = selectedPlayer && selectedPlayer.id;
            const isCurrentUser = loggedInUserId === playerId;
            console.log(`PLAYER ID: ${playerId}`)

            React.useEffect(() => {
                if (playerId) {
                    const url = `/get_decks/${parseInt(playerId)}`;

                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data);
                            setPlayer(data["user"]);
                            setDecksPlayer(data["decks"])
                            setSelectedDeck(null)
                        })
                        .catch(error => console.error(`There was a problem while fetching deck with ID: ${playerId}`, error));
                }
            }, [playerId]); // Only re-run the effect if deckId changes

            if (!player) {
                return <div>No data available for this deck.</div>;
            }

            const handleDeckClick = (deckId) => {
                console.log(deckId);
                setSelectedDeck({ id: deckId });
            };

            // Function to get CSRF token from cookies
            function getCSRFToken() {
                const cookies = document.cookie.split("; ");
                for (let cookie of cookies) {
                    if (cookie.startsWith("csrftoken=")) {
                        return cookie.split("=")[1];
                    }
                }
                return "";
            }

            // Fetch deck options and match results on form open
            const fetchOptions = async () => {
                try {
                    const response = await fetch("/get_options/deck");
                    const data = await response.json();
                    console.log(data)
                    setCategory(data["category"]);
                } catch (error) {
                    console.error("Error fetching options:", error);
                }
            };

            const handleAddClick = () => {
                setShowForm(true);
                fetchOptions();
            }

            const handleSubmitForm = (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);

                fetch("/add_deck", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    }
                }).then(response => {
                    if (response.ok) {
                        setShowForm(false);
                        window.location.reload()
                    } else {
                        console.error("Failed to add Deck");
                    }
                });
            }

            return (
                <div>
                    <h1>{player.username}. Win Ratio: {player.win_ratio}%</h1>
                    <div className="results-page-container">
                        <div className="results-table">
                            <table className="table">
                                <thead className="table-light, table-results">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Deck</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Total Matches</th>
                                        <th scope="col">Victories</th>
                                        <th scope="col">Defeats</th>
                                        <th scope="col">Draws</th>
                                        <th scope="col">Win Ratio</th>
                                    </tr>
                                </thead>
                                <tbody className="table-group-divider">
                                {decksPlayer && decksPlayer.length > 0 ? (
                                    decksPlayer.map((deck, index) => (
                                    <tr key={deck.id}>
                                        <th scope="row">{index + 1}</th>
                                        <td className="clickable" onClick={() => handleDeckClick(deck.id)}>{deck.name}</td>
                                        <td>{deck.category}</td>
                                        <td>{deck.total_matches}</td>
                                        <td>{deck.wins}</td>
                                        <td>{deck.losses}</td>
                                        <td>{deck.draws}</td>
                                        <td>{deck.win_ratio}%</td>
                                    </tr>
                                ))

                                ) : (
                                    <tr>
                                        <td colSpan="8">No decks available for this player.</td>
                                    </tr>
                                )}
                                {isCurrentUser && (
                                    <tr>
                                        <td>
                                            <button className="button-add" onClick={handleAddClick}>
                                                <img src="/static/mtg/img/add-button.png" alt="Add Deck" />
                                            </button>
                                        </td>
                                    </tr>
                                )
                                }

                                </tbody>
                            </table>
                        </div>

                        {/* Form to add new Deck */}
                        {showForm &&  (
                            <form onSubmit={handleSubmitForm} className="add-match-form">
                                <h3>Add New Deck</h3>
                                <div>
                                    <label>Name: </label>
                                    <input name="name"/>
                                </div>
                                <div>
                                    <label>Category: </label>
                                    <select name="category">
                                        {category.length > 0 ? (
                                            category.map(c => (
                                            <option key={c.id} value={c.id}>{c.label}</option>
                                        ))
                                        ) : (
                                            <option disabled>Loading categories... </option>
                                        )
                                        }
                                    </select>
                                </div>
                                <button type="submit">Submit</button>
                                <button type="button" onClick={() => setShowForm(false)}>Cancel</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const RenderBestDecks = ({setSelectedPlayer, setSelectedDeck}) => {
            const [bestDecks, setBestDecks] = React.useState([]);

            React.useEffect(() => {
                const url = "/get_best?type=deck&n=10"
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error while fetching Best Decks");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data)
                        setBestDecks(data)
                    })
                    .catch(error => console.error("There was a problem while fetching Best Decks", error))
            }, []);

            const handleDeckClick = (rivalId) => {
                console.log(rivalId);
                setSelectedPlayer(null)
                setSelectedDeck({id: rivalId});
            };

            const handleOwnerClick = (rivalOwnerId) => {
                console.log(rivalOwnerId);
                setSelectedDeck(null)
                setSelectedPlayer({id: rivalOwnerId})
            };

            return (
                <div>
                    <h1>Hall of Fame</h1>
                    <div className="results-page-container">
                        <div className="results-table">
                            <table className="table">
                                <thead className="table-light, table-results">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Deck</th>
                                    <th scope="col">Owner</th>
                                    <th scope="col">Total Matches</th>
                                    <th scope="col">Victories</th>
                                    <th scope="col">Defeats</th>
                                    <th scope="col">Draws</th>
                                    <th scope="col">Win Ratio</th>
                                </tr>
                                </thead>
                                <tbody className="table-group-divider">
                                {bestDecks.map((bestDeck, index) => (
                                    <tr key={bestDeck.id}>
                                        <th scope="row">{index + 1}</th>
                                        <td className="clickable"
                                            onClick={() => handleDeckClick(bestDeck.id)}>{bestDeck.name}</td>
                                        <td className="clickable"
                                            onClick={() => handleOwnerClick(bestDeck.ownerId)}>{bestDeck.owner}</td>
                                        <td>{bestDeck.total_matches}</td>
                                        <td>{bestDeck.wins}</td>
                                        <td>{bestDeck.losses}</td>
                                        <td>{bestDeck.draws}</td>
                                        <td>{bestDeck.win_ratio}%</td>
                                    </tr>
                                ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }


    ReactDOM.render(<App />, document.querySelector("#App"));

    </script>

</body>
</html>